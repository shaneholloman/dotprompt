#!/usr/bin/env bash
# Copyright 2026 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
VIM_PKG_DIR="$REPO_ROOT/packages/vim"

# Default target directories
VIM_DIR="$HOME/.vim"
NVIM_DIR="$HOME/.config/nvim"

usage() {
  echo "Usage: $0 [options]"
  echo "Options:"
  echo "  -d, --dest DIR    Destination directory (default: tries ~/.vim, then ~/.config/nvim)"
  echo "  -f, --force       Overwrite existing files without prompting"
  echo "  --no-lsp          Skip building promptly LSP server"
  echo "  -h, --help        Show this help message"
  exit 1
}

# Parse arguments
DEST_DIR=""
FORCE=false
BUILD_LSP=true

while [[ "$#" -gt 0 ]]; do
  case $1 in
    -d|--dest) DEST_DIR="$2"; shift ;;
    -f|--force) FORCE=true ;;
    --no-lsp) BUILD_LSP=false ;;
    -h|--help) usage ;;
    *) echo "Unknown parameter passed: $1"; usage ;;
  esac
  shift
done

# Determine destination if not specified
if [[ -z "$DEST_DIR" ]]; then
  if [[ -d "$VIM_DIR" ]]; then
    DEST_DIR="$VIM_DIR"
  elif [[ -d "$NVIM_DIR" ]]; then
    DEST_DIR="$NVIM_DIR"
  else
    echo "No standard Vim/Neovim directory found."
    echo "Creating ~/.vim..."
    mkdir -p "$VIM_DIR"
    DEST_DIR="$VIM_DIR"
  fi
fi

echo "=========================================="
echo "Dotprompt Vim/Neovim Plugin Installer"
echo "=========================================="

# Build promptly LSP server
PROMPTLY_BIN=""
if [ "$BUILD_LSP" = true ]; then
  echo ""
  echo "Step 1: Building promptly LSP server..."
  if command -v cargo &> /dev/null; then
    cd "$REPO_ROOT"
    cargo build --release -p promptly
    PROMPTLY_BIN="$REPO_ROOT/target/release/promptly"
    if [ -f "$PROMPTLY_BIN" ]; then
      echo "  ✓ promptly built successfully"
      
      # Install to ~/.local/bin for PATH discovery
      LOCAL_BIN="$HOME/.local/bin"
      mkdir -p "$LOCAL_BIN"
      cp "$PROMPTLY_BIN" "$LOCAL_BIN/promptly"
      chmod +x "$LOCAL_BIN/promptly"
      echo "  ✓ Installed promptly to $LOCAL_BIN/promptly"
      PROMPTLY_BIN="$LOCAL_BIN/promptly"
      
      # Check if ~/.local/bin is in PATH
      if [[ ":$PATH:" != *":$LOCAL_BIN:"* ]]; then
        echo ""
        echo "  ⚠ $LOCAL_BIN is not in your PATH."
        echo "    Add this to your shell profile (~/.bashrc, ~/.zshrc, etc.):"
        echo "    export PATH=\"\$HOME/.local/bin:\$PATH\""
      fi
    fi
  else
    echo "  ⚠ cargo not found. Skipping LSP build."
    echo "    Install Rust (https://rustup.rs) for LSP features."
  fi
fi

echo ""
echo "Step 2: Installing Vim plugin to: $DEST_DIR"

# Create directories
mkdir -p "$DEST_DIR/syntax"
mkdir -p "$DEST_DIR/ftdetect"

# Copy files
echo "  Copying syntax/dotprompt.vim..."
if [ -f "$DEST_DIR/syntax/dotprompt.vim" ] && [ "$FORCE" = false ]; then
  read -p "  File exists. Overwrite? (y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "  Skipping syntax file."
  else
    cp "$VIM_PKG_DIR/syntax/dotprompt.vim" "$DEST_DIR/syntax/"
  fi
else
  cp "$VIM_PKG_DIR/syntax/dotprompt.vim" "$DEST_DIR/syntax/"
fi

echo "  Copying ftdetect/dotprompt.vim..."
if [ -f "$DEST_DIR/ftdetect/dotprompt.vim" ] && [ "$FORCE" = false ]; then
  read -p "  File exists. Overwrite? (y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "  Skipping ftdetect file."
  else
    cp "$VIM_PKG_DIR/ftdetect/dotprompt.vim" "$DEST_DIR/ftdetect/"
  fi
else
  cp "$VIM_PKG_DIR/ftdetect/dotprompt.vim" "$DEST_DIR/ftdetect/"
fi

echo ""
echo "=========================================="
echo "Installation Complete!"
echo "=========================================="
echo ""
echo "Syntax highlighting is now enabled for .prompt files."
echo ""

# Check if this is Neovim
if [[ "$DEST_DIR" == *"nvim"* ]] || command -v nvim &> /dev/null; then
  echo "For Neovim LSP support with nvim-lspconfig, add to your init.lua:"
  echo ""
  echo '  local lspconfig = require("lspconfig")'
  echo '  local configs = require("lspconfig.configs")'
  echo '  '
  echo '  if not configs.promptly then'
  echo '    configs.promptly = {'
  echo '      default_config = {'
  if [ -n "$PROMPTLY_BIN" ] && [ -f "$PROMPTLY_BIN" ]; then
    echo "        cmd = { \"$PROMPTLY_BIN\", \"lsp\" },"
  else
    echo '        cmd = { "promptly", "lsp" },'
  fi
  echo '        filetypes = { "dotprompt" },'
  echo '        root_dir = lspconfig.util.find_git_ancestor,'
  echo '      },'
  echo '    }'
  echo '  end'
  echo '  '
  echo '  lspconfig.promptly.setup({})'
else
  echo "For Vim LSP support with vim-lsp, add to your .vimrc:"
  echo ""
  echo "  if executable('promptly')"
  echo "    au User lsp_setup call lsp#register_server({"
  echo "      \\ 'name': 'promptly',"
  if [ -n "$PROMPTLY_BIN" ] && [ -f "$PROMPTLY_BIN" ]; then
    echo "      \\ 'cmd': {server_info->['$PROMPTLY_BIN', 'lsp']},"
  else
    echo "      \\ 'cmd': {server_info->['promptly', 'lsp']},"
  fi
  echo "      \\ 'allowlist': ['dotprompt'],"
  echo "      \\ })"
  echo "  endif"
fi
