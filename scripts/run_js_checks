#!/usr/bin/env bash
# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

set -euo pipefail

FORCE_INSTALL=false

# Parse arguments
for arg in "$@"; do
  case $arg in
    --force-install)
      FORCE_INSTALL=true
      shift
      ;;
  esac
done

# Node versions to test against (matching CI matrix)
NODE_VERSIONS=("20" "21" "22" "23" "24")

# Function to initialize fnm in the current script scope
init_fnm() {
  if command -v fnm &> /dev/null; then
    eval "$(fnm env --use-on-cd)"
  else
    # Try typical install location if not in PATH
    export PATH="$HOME/.local/share/fnm:$PATH"
    if command -v fnm &> /dev/null; then
      eval "$(fnm env --use-on-cd)"
    fi
  fi
}

# Initial attempt to setup fnm
init_fnm

if ! command -v fnm &> /dev/null; then
  echo "Error: fnm is not installed."
  
  INSTALL_CONFIRMED=false
  
  if [ "$FORCE_INSTALL" = true ]; then
    INSTALL_CONFIRMED=true
  else
    read -p "Would you like to install fnm automatically? (y/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      INSTALL_CONFIRMED=true
    fi
  fi

  if [ "$INSTALL_CONFIRMED" = true ]; then
    echo "Installing fnm..."
    curl -fsSL https://fnm.vercel.app/install | bash -s -- --skip-shell
    # Source fnm for the current session
    export PATH="$HOME/.local/share/fnm:$PATH"
    eval "$(fnm env --use-on-cd)"
  else
    echo "Please install fnm manually: https://github.com/Schniz/fnm"
    exit 1
  fi
fi

echo "Running JS tests across Node versions: ${NODE_VERSIONS[*]}"

for version in "${NODE_VERSIONS[@]}"; do
  echo "--------------------------------------------------"
  echo "Staging Node.js v$version..."
  
  # Try to install/use the version
  if fnm install "$version"; then
    fnm use "$version"
    
    echo "Node version: $(node -v)"
    echo "Installing dependencies..."
    # Ensure pnpm is available for this node version
    if ! command -v pnpm &> /dev/null; then
        npm install -g pnpm
    fi
    
    pnpm -C js install --frozen-lockfile

    echo "Running tests..."
    pnpm -C js test

    echo "Building (tsc)..."
    pnpm -C js build

    echo "Building (tsgo)..."
    pnpm -C js build:native
    
    echo "✅ Success for Node v$version"
  else
    echo "⚠️  Could not install/use Node v$version. Skipping."
  fi
done

echo "--------------------------------------------------"
echo "All done! Restoring original node version..."
fnm use default || true
