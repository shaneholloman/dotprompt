#!/bin/bash
# Copyright 2026 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

# Generate ANTLR4 Dart parser from Handlebars grammar
# Usage: ./scripts/generate_handlebars_parser

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
GRAMMAR_DIR="${REPO_ROOT}/spec/handlebars/antlr"
OUTPUT_DIR="${REPO_ROOT}/dart/handlebarrz/lib/src/antlr"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "=========================================="
echo "Generating ANTLR4 Handlebars Parser (Dart)"
echo "=========================================="

# Check for antlr4 command
ANTLR_CMD=""
if command -v antlr4 &> /dev/null; then
    ANTLR_CMD="antlr4"
elif command -v antlr &> /dev/null; then
    ANTLR_CMD="antlr"
elif [ -f "/opt/homebrew/Cellar/antlr/4.13.2/bin/antlr" ]; then
    ANTLR_CMD="/opt/homebrew/Cellar/antlr/4.13.2/bin/antlr"
else
    echo -e "${RED}Error: ANTLR4 not found${NC}"
    echo "Install with: brew install antlr"
    exit 1
fi

echo -e "${GREEN}Using ANTLR: ${ANTLR_CMD}${NC}"

# Create output directory if needed
mkdir -p "${OUTPUT_DIR}"

# Generate lexer
echo "Generating lexer..."
cd "${GRAMMAR_DIR}"
${ANTLR_CMD} -Dlanguage=Dart HandlebarsLexer.g4

# Generate parser with visitor
echo "Generating parser with visitor..."
${ANTLR_CMD} -Dlanguage=Dart -visitor -no-listener HandlebarsParser.g4

# Move generated files to handlebarrz
echo "Moving generated files to ${OUTPUT_DIR}..."
mv -f HandlebarsLexer.dart "${OUTPUT_DIR}/"
mv -f HandlebarsParser.dart "${OUTPUT_DIR}/"
mv -f HandlebarsParserVisitor.dart "${OUTPUT_DIR}/"
mv -f HandlebarsParserBaseVisitor.dart "${OUTPUT_DIR}/"

# Remove any listener files (we only use visitor)
rm -f HandlebarsParserListener.dart HandlebarsParserBaseListener.dart

# Add header comment to generated files
echo "Adding license headers..."
for file in "${OUTPUT_DIR}"/*.dart; do
    if [ -f "$file" ]; then
        # Check if already has license
        if ! grep -q "Copyright 2026 Google LLC" "$file"; then
            # Prepend license header
            TEMP_FILE=$(mktemp)
            cat > "$TEMP_FILE" << 'EOF'
// Copyright 2026 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
// SPDX-License-Identifier: Apache-2.0
//
// GENERATED FILE - DO NOT EDIT
// Generated by: scripts/generate_handlebars_parser
// Source: spec/handlebars/antlr/Handlebars*.g4

EOF
            cat "$file" >> "$TEMP_FILE"
            mv "$TEMP_FILE" "$file"
        fi
    fi
done

echo ""
echo -e "${GREEN}Successfully generated ANTLR4 parser!${NC}"
echo ""
echo "Generated files:"
ls -la "${OUTPUT_DIR}"/*.dart
echo ""
echo "Next steps:"
echo "1. Add 'antlr4: ^4.13.2' to dart/handlebarrz/pubspec.yaml"
echo "2. Create visitor to build AST nodes"
echo "3. Run tests to verify parity with hand-written parser"
