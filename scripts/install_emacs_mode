#!/usr/bin/env bash
# Copyright 2026 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
EMACS_PKG_DIR="$REPO_ROOT/packages/emacs"

# Default target directory
EMACS_LISP_DIR="$HOME/.emacs.d/lisp"

usage() {
  echo "Usage: $0 [options]"
  echo "Options:"
  echo "  -d, --dest DIR    Destination directory (default: ~/.emacs.d/lisp)"
  echo "  --no-lsp          Skip building promptly LSP server"
  echo "  -h, --help        Show this help message"
  exit 1
}

# Parse arguments
DEST_DIR=""
BUILD_LSP=true

while [[ "$#" -gt 0 ]]; do
  case $1 in
    -d|--dest) DEST_DIR="$2"; shift ;;
    --no-lsp) BUILD_LSP=false ;;
    -h|--help) usage ;;
    *) echo "Unknown parameter passed: $1"; usage ;;
  esac
  shift
done

# Detect Doom Emacs configuration directory
DOOM_CONFIG_DIR=""
if [[ -d "$HOME/.doom.d" ]]; then
  DOOM_CONFIG_DIR="$HOME/.doom.d"
elif [[ -d "$HOME/.config/doom" ]]; then
  DOOM_CONFIG_DIR="$HOME/.config/doom"
fi

# Determine destination if not specified
if [[ -z "$DEST_DIR" ]]; then
  if [[ -n "$DOOM_CONFIG_DIR" ]]; then
    DEST_DIR="$DOOM_CONFIG_DIR/lisp"
  else
    DEST_DIR="$EMACS_LISP_DIR"
  fi
fi

echo "=========================================="
echo "Dotprompt Emacs Mode Installer"
echo "=========================================="

# Build promptly LSP server
if [ "$BUILD_LSP" = true ]; then
  echo ""
  echo "Step 1: Building promptly LSP server..."
  if command -v cargo &> /dev/null; then
    cd "$REPO_ROOT"
    cargo build --release -p promptly
    PROMPTLY_BIN="$REPO_ROOT/target/release/promptly"
    if [ -f "$PROMPTLY_BIN" ]; then
      echo "  ✓ promptly built successfully"
      
      # Install to ~/.local/bin for PATH discovery
      LOCAL_BIN="$HOME/.local/bin"
      mkdir -p "$LOCAL_BIN"
      cp "$PROMPTLY_BIN" "$LOCAL_BIN/promptly"
      chmod +x "$LOCAL_BIN/promptly"
      echo "  ✓ Installed promptly to $LOCAL_BIN/promptly"
      
      # Check if ~/.local/bin is in PATH
      if [[ ":$PATH:" != *":$LOCAL_BIN:"* ]]; then
        echo ""
        echo "  ⚠ $LOCAL_BIN is not in your PATH."
        echo "    Add this to your shell profile (~/.bashrc, ~/.zshrc, etc.):"
        echo "    export PATH=\"\$HOME/.local/bin:\$PATH\""
      fi
    fi
  else
    echo "  ⚠ cargo not found. Skipping LSP build."
    echo "    Install Rust (https://rustup.rs) for LSP features."
  fi
fi

echo ""
echo "Step 2: Installing Emacs mode to: $DEST_DIR"

# Create directory
mkdir -p "$DEST_DIR"

# Copy file (always overwrite - this is an installer/updater)
echo "  Copying dotprompt-mode.el..."
cp "$EMACS_PKG_DIR/dotprompt-mode.el" "$DEST_DIR/"
echo "  ✓ Installed dotprompt-mode.el"

# Doom Emacs Auto-config
CONFIG_UPDATED=false
ALREADY_CONFIGURED=false
if [[ -n "$DOOM_CONFIG_DIR" ]]; then
  echo ""
  echo "Step 3: Doom Emacs detected in $DOOM_CONFIG_DIR"
  CONFIG_EL="$DOOM_CONFIG_DIR/config.el"
  if [[ -f "$CONFIG_EL" ]]; then
    if grep -q "dotprompt-mode" "$CONFIG_EL"; then
      echo "  ✓ dotprompt-mode already configured in $CONFIG_EL"
      ALREADY_CONFIGURED=true
    else
      echo "  Updating $CONFIG_EL..."
      cat >> "$CONFIG_EL" <<EOF

;; Dotprompt support
(add-to-list 'load-path "$DEST_DIR")
(require 'dotprompt-mode)
(add-hook 'dotprompt-mode-hook #'eglot-ensure)
EOF
      echo "  ✓ Configuration added to $CONFIG_EL"
      CONFIG_UPDATED=true
    fi
  else
    echo "  ⚠ config.el not found in $DOOM_CONFIG_DIR. Skipping auto-config."
  fi
fi

echo ""
echo "=========================================="
echo "Installation Complete!"
echo "=========================================="
echo ""

if [ "$CONFIG_UPDATED" = true ]; then
  echo "Your Doom Emacs configuration has been automatically updated."
  echo "Please restart Emacs or run 'M-x load-file' on your config.el."
elif [ "$ALREADY_CONFIGURED" = true ]; then
  echo "Your Doom Emacs configuration is already up to date."
else
  echo "Add the following to your Emacs init file (~/.emacs or ~/.emacs.d/init.el):"
  echo ""
  echo "  (add-to-list 'load-path \"$DEST_DIR\")"
  echo "  (require 'dotprompt-mode)"
  echo ""
  echo "For LSP support with eglot (Emacs 29+), also add:"
  echo ""
  echo "  (add-hook 'dotprompt-mode-hook 'eglot-ensure)"
fi

echo ""
if [ "$BUILD_LSP" = true ] && [ -f "$HOME/.local/bin/promptly" ]; then
  echo "promptly is installed at ~/.local/bin/promptly"
  echo "If ~/.local/bin is in your PATH, LSP will work automatically."
  echo ""
  echo "Otherwise, add to your Emacs config:"
  echo ""
  echo "  (setq dotprompt-promptly-path \"$HOME/.local/bin/promptly\")"
fi
