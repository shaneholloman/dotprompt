#!/usr/bin/env bash
# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

# Serves the MkDocs documentation locally with live reload.
# Usage: ./scripts/serve_docs [--build]
#
# Options:
#   --build    Build static site instead of serving (outputs to site/)

set -euo pipefail

if ((EUID == 0)); then
  echo "Please do not run as root"
  exit 1
fi

TOP_DIR=$(git rev-parse --show-toplevel)
cd "$TOP_DIR"

# Check for D2 (diagramming tool)
if ! command -v d2 &>/dev/null; then
  if ! command -v go &>/dev/null; then
    echo "Error: D2 requires Go. Please install Go first."
    exit 1
  fi
  echo "Installing D2 diagramming tool..."
  go install oss.terrastruct.com/d2@latest
fi

# Install mkdocs and plugins if not available
if ! command -v mkdocs &>/dev/null; then
  echo "Installing mkdocs and plugins..."
  uv tool install mkdocs \
    --with mkdocs-autorefs \
    --with mkdocs-d2-plugin \
    --with mkdocs-literate-nav \
    --with mkdocs-material \
    --with mkdocs-mermaid2-plugin \
    --with mkdocs-minify-plugin \
    --with "mkdocstrings[python]"
fi

# Parse arguments
BUILD_ONLY=false
for arg in "$@"; do
  case $arg in
  --build)
    BUILD_ONLY=true
    shift
    ;;
  esac
done

if [ "$BUILD_ONLY" = true ]; then
  echo "Building documentation..."
  mkdocs build
  echo "Documentation built in site/"
else
  echo "Serving documentation at http://127.0.0.1:8000"
  echo "Press Ctrl+C to stop"
  mkdocs serve
fi
