#!/usr/bin/env bash
# Copyright 2026 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

# Script to format all Lua files in the workspace using StyLua.

set -euo pipefail

# Parse arguments
ARGS=""
if [[ $# -gt 0 && ($1 == "--check" || $1 == "-c") ]]; then
  ARGS="--check"
fi

# Try to find stylua
if command -v stylua &> /dev/null; then
  STYLUA="stylua"
else
  # Check if in node_modules
  if [ -f "./node_modules/.bin/stylua" ]; then
    STYLUA="./node_modules/.bin/stylua"
  else
    echo "StyLua not found, skipping Lua formatting. Install with: cargo install stylua"
    exit 0
  fi
fi

# Find all .lua files
LUA_FILES=$(find . -type d \( -name .git -o -name .cache -o -name node_modules \) -prune -o -name "*.lua" -print)

if [ -z "${LUA_FILES}" ]; then
  echo "No Lua files found to format."
  exit 0
fi

if [[ "$ARGS" == "--check" ]]; then
  echo "=== Checking Lua formatting... ==="
else
  echo "=== Formatting Lua files... ==="
fi

$STYLUA $ARGS ${LUA_FILES}

if [[ "$ARGS" == "--check" ]]; then
  echo "âœ… Lua formatting check passed."
else
  echo "=== Lua formatting complete. ==="
fi
