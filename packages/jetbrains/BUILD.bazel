# Copyright 2026 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

"""Build rules for the Dotprompt JetBrains plugin."""

load("@rules_kotlin//kotlin:jvm.bzl", "kt_jvm_library")

package(default_visibility = ["//visibility:public"])

# Kotlin sources for the plugin.
# PromptlyServerFactory.kt is excluded because it depends on LSP4IJ
# which is only available at runtime via the IntelliJ plugin system.
SOURCES = [
    "src/main/kotlin/com/google/dotprompt/DotpromptCommenter.kt",
    "src/main/kotlin/com/google/dotprompt/DotpromptFileType.kt",
    "src/main/kotlin/com/google/dotprompt/DotpromptIcons.kt",
    "src/main/kotlin/com/google/dotprompt/DotpromptLanguage.kt",
    "src/main/kotlin/com/google/dotprompt/DotpromptLexer.kt",
    "src/main/kotlin/com/google/dotprompt/DotpromptParserDefinition.kt",
    "src/main/kotlin/com/google/dotprompt/DotpromptSyntaxHighlighter.kt",
    "src/main/kotlin/com/google/dotprompt/DotpromptTokenTypes.kt",
    "src/main/kotlin/com/google/dotprompt/PromptlyServerConfig.kt",
]

# Resources for the plugin.
RESOURCES = [
    "src/main/resources/META-INF/plugin.xml",
    "src/main/resources/icons/dotprompt.svg",
]

# Main plugin library compiled with rules_kotlin
kt_jvm_library(
    name = "dotprompt-intellij",
    srcs = SOURCES,
    resources = RESOURCES,
    deps = [
        "@intellij_maven//:com_jetbrains_intellij_platform_analysis",
        "@intellij_maven//:com_jetbrains_intellij_platform_core",
        "@intellij_maven//:com_jetbrains_intellij_platform_core_impl",
        "@intellij_maven//:com_jetbrains_intellij_platform_editor",
        "@intellij_maven//:com_jetbrains_intellij_platform_indexing",
        "@intellij_maven//:com_jetbrains_intellij_platform_lang",
        "@intellij_maven//:com_jetbrains_intellij_platform_lang_impl",
        "@intellij_maven//:com_jetbrains_intellij_platform_util",
    ],
)

# Export all source files for IDE support
filegroup(
    name = "sources",
    srcs = SOURCES + [
        # Include LSP4IJ-dependent file for Gradle builds
        "src/main/kotlin/com/google/dotprompt/PromptlyServerFactory.kt",
    ],
)

# Export all resources (plugin.xml, icons, etc.)
filegroup(
    name = "resources",
    srcs = RESOURCES,
)

# Export everything for the Gradle build (alternative build method)
filegroup(
    name = "plugin_files",
    srcs = [
        "build.gradle.kts",
        "settings.gradle.kts",
        ":resources",
        ":sources",
    ],
)
